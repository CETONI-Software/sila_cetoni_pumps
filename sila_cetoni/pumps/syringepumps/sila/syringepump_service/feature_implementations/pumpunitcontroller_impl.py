# Generated by sila2.code_generator; sila2.__version__: 0.10.1
from __future__ import annotations

import logging
from collections import namedtuple
from typing import Any

from qmixsdk.qmixpump import Pump
from sila2.server import MetadataDict, SilaServer

from sila_cetoni.application.system import ApplicationSystem, CetoniApplicationSystem
from sila_cetoni.utils import PropertyUpdater, not_equal

from ..... import unit_conversion as uc
from ..generated.pumpunitcontroller import (
    PumpUnitControllerBase,
    PumpUnitControllerFeature,
    SetFlowUnit_Responses,
    SetVolumeUnit_Responses,
    VolumeUnit,
)

logger = logging.getLogger(__name__)


FlowUnit = namedtuple("FlowUnit", ["VolumeUnit", "TimeUnit"])


@CetoniApplicationSystem.monitor_traffic
class PumpUnitControllerImpl(PumpUnitControllerBase):
    __pump: Pump
    __system: ApplicationSystem

    def __init__(self, server: SilaServer, pump: Pump):
        super().__init__(server)
        self.__pump = pump
        self.__system = ApplicationSystem()

        self.run_periodically(
            PropertyUpdater(
                lambda: FlowUnit(*uc.flow_unit_to_tuple(self.__pump.get_flow_unit())),
                not_equal,
                self.update_FlowUnit,
                when=self.__system.state.is_operational,
            )
        )
        self.run_periodically(
            PropertyUpdater(
                lambda: uc.volume_unit_to_string(self.__pump.get_volume_unit()),
                not_equal,
                self.update_VolumeUnit,
                when=self.__system.state.is_operational,
            )
        )

    @ApplicationSystem.ensure_operational(PumpUnitControllerFeature)
    def SetFlowUnit(self, FlowUnit: Any, *, metadata: MetadataDict) -> SetFlowUnit_Responses:
        logger.debug(f"flow unit {FlowUnit} {type(FlowUnit)}")

        # try:
        flow_unit = FlowUnit
        prefix, volume_unit, time_unit = uc.evaluate_units(
            parameter=PumpUnitControllerFeature["SetFlowUnit"].parameters.fields[0],
            requested_volume_unit=flow_unit.VolumeUnit,
            requested_time_unit=flow_unit.TimeUnit,
        )
        # except ValueError:
        #     err = ValidationError(
        #         "The given flow unit is malformed. It has to be something like 'ml/s', for instance."
        #     )
        #     err.parameter_fully_qualified_identifier = (
        #         PumpUnitControllerFeature["SetFlowUnit"].parameters.fields[0].fully_qualified_identifier
        #     )
        #     raise err
        # else:
        self.__pump.set_flow_unit(prefix, volume_unit, time_unit)

    @ApplicationSystem.ensure_operational(PumpUnitControllerFeature)
    def SetVolumeUnit(self, VolumeUnit: VolumeUnit, *, metadata: MetadataDict) -> SetVolumeUnit_Responses:
        prefix, volume_unit = uc.evaluate_units(
            parameter=PumpUnitControllerFeature["SetVolumeUnit"].parameters.fields[0], requested_volume_unit=VolumeUnit
        )
        self.__pump.set_volume_unit(prefix, volume_unit)
